# PRINT_CANCEL
A print generally ends in one of two ways - either it is successful and completes normally, or something goes awry and you cancel it. Klipper can be configured to do different things in each case.
Here, we're addressing what to do when a print is prematurely canceled. Note that if an "emergency stop" mechanism is used, this macro will not be executed.

The main things we're doing here are calling the timer to log the elapsed time if the TIMER macros are being used, and then positioning the toolhead out of the way. In this example, it is moved
to the front of the printer, center-top, so it is easy to have a look at the nozzle and see if anything is amiss. This can also serve as a visual cue that the print was canceled. 
Note that a print could be canceled automatically due to missed temperature targets and that kind of thing.

NOTE: For this to be called, Klipper must be told about it. This is handled using the "on_error_gcode" directive which typically appears near the top of the printer.cfg file. 
It, and the PRINT_CANCEL macro, may already exist or might not be present. Be sure to also check for CANCEL_PRINT macro and consider combining the two into one macro. 
Alternatively, this directive could be added to the g-code generated by the slicer.
``` 
on_error_gcode: PRINT_CANCEL
```
NOTE: Due to the single-threaded nature of Klipper and other aspects of its core architecture, running the PRINT_CANCEL macro doesn't usually immediately stop the print. It will complete the G-code 
command it is currently working on. If that's printing a line of filament, as in a NOZZLE_PRIME, then the entire line will print before it recognizes the cancel request. If it is running another
macro, that macro will complete before the request for PRINT_CANCEL is dealt with.

In particular, if the PRINT_START macro is running, Klipper will wait until the *entire* macro completes before acknowledging the cancel request. 
It may often be quicker to use the emergency stop function and restart Klipper rather than wait for it to finish, particularly if you want to cancel a print job before it has laid down any filament. 
```
######################################
# PRINT_CANCEL macro
#######################################
[gcode_macro PRINT_CANCEL]
description: Cancel print abruptly
gcode:

    # Show elapsed time (Note: Requires TIMER macros)
    # RUN_SHELL_COMMAND CMD=shell_get_elapsed_time PARAMS='__CANCELLED'
    
    # Retract filament if possible
    {% if printer.extruder.can_extrude %}
        G91               # Relative positioning
        G1 E-5.00 F1000   # Retract 5mm of filament
    {% else %}
        M118 PRINT_CANCEL: Extruder Temp: {printer.extruder.temperature}
        M118 PRINT_CANCEL: Extruder too cool to retract
    {% endif %}

    # The toolhead is presented for inspection following a failure
    {% if printer.toolhead.homed_axes == "xyz" %}
        {% set x_park = (printer.configfile.settings['stepper_x'].position_max - printer.configfile.settings['stepper_x'].position_min) / 2 %}
        {% set y_park = printer.configfile.settings['stepper_y'].position_min %}
        {% set z_park = printer.configfile.settings['stepper_z'].position_max %}

        {% set x_speed = printer.configfile.settings['stepper_x'].homing_speed * 60.0 %}  # homing = mm/s, but F = mm/min 
        {% set y_speed = printer.configfile.settings['stepper_y'].homing_speed * 60.0 %}  # homing = mm/s, but F = mm/min 
        {% set z_speed = printer.configfile.settings['stepper_z'].homing_speed * 60.0 %}  # homing = mm/s, but F = mm/min

        G90                          # Absolute positioning
        G1 Z{z_park} F{z_speed}      # Max Z first
        G1 X{x_park} F{x_speed}      # Center X
        G1 Y{y_park} F{y_speed}      # Front Y
    {% else %}
        M118 PRINT_CANCEL: No movement as printer is not homed
    {% endif %}

    # Turn off heaters - let things cool down
    TURN_OFF_HEATERS                       

    # Turn on part cooling fan to max to cool nozzle
    M106

    # Exhaust fan to max (Note: Requires [fan_generic exhaust_fan] configured)
    # SET_FAN_SPEED FAN=exhaust_fan SPEED=1.0  # Exhaust fan to max -> cool chamber fast

    # Unpause if paused
    CLEAR_PAUSE

    # Cancel the job
    BASE_CANCEL_PRINT



#######################################
# CANCEL_PRINT macro
#######################################
[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    PRINT_CANCEL
    BASE_CANCEL_PRINT
```

#
Parent: [Macros Quick Reference](https://github.com/500Foods/WelcomeToTroodon#%EF%B8%8F-macros-quick-reference)
